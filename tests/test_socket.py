# test_socket.py - Tests whether or not the TlsSocket class operates as intended.

from datetime import date
from os import environ
import unittest
from veeder_root_tls_socket_library.socket import TlsSocket

class test_tlsSocket(unittest.TestCase):
    def setUp(self):
        self.ip   = environ["TLS_IP"]
        self.port = int(environ["TLS_PORT"])

        if not self.ip or not self.port:
            raise ValueError("TLS_IP and TLS_PORT environment variables must have values.")
    
    def test_valid_command(self):
        """
        Verify that tlsSocket.execute() and your system return the same date to test communication.
        """

        today = date.today() 
        expected = today.strftime("%y%m")

        with TlsSocket(self.ip, self.port) as tls:
            actual = tls.execute("i10100")[:4]

        self.assertEqual(expected, actual)
    
    def test_invalid_command(self):
        """
        Verify that tlsSocket.execute() handles invalid commands by returning a ValueError.
        """

        with TlsSocket(self.ip, self.port) as tls:
            with self.assertRaises(ValueError):
                tls.execute("test")

    def test_checksum(self):
        """
        Verify that TlsSocket._data_integrity_check() correctly validates outputs.
        """

        # Cases are tuples with the full command output and expected checksum validation result.
        cases = [
            (b"\x01i101002312301342020402&&FB3B\x03", True),
            (b"\x01i101002312301342020402&&FB3A\x03", False),
            (b"\x01j101002312301342020402&&FB3B\x03", False),
            ( 
                # This humongous test is for checking if the data integrity check only gets 
                # the least significant 4 bytes of the message prior to adding it to the checksum.
                (
                    b"\x01i21B0025020909450133230321114323032111491542CBE1C143D81D4543A524D543A6302641"
                    b"0ACA2A42674A0B4267230442675A604267E23C4269753842701A2341E681544251C8A64251A60442"
                    b"563EB5425FFF514265B0C0426FCB2900000000426772DB42525F83230307080123030708071542E2"
                    b"E03E43EBDF8C43B3277C43B55C0C4117B7384263073B426221014261F78F42622C07426360CD426A"
                    b"82C141FA8B0D42372E24423721EF423A5EFC424FE982425BFB064269F1BF000000004263BB704237"
                    b"9FAF23022109042302210915154341F1234401A94343A259F543A46311416AEBF84269A8A24268F7"
                    b"9342689355426844194267418742697C65420A14C4424063EF4240555B42412486424EAEEE425DFF"
                    b"3742694258000000004269E8A74240DDF4230207084123020708501542DC1C5443FFE15043C8DA3B"
                    b"43CB9D964113F366426DCA2A426D460E426D238B426D0B1F426CA60A4270CD7E42081D0442313ECF"
                    b"4230FD6342329986424A411F4260410A4270B54F00000000426E31444231E7E32301240823230124"
                    b"08311542CEED8243FED25B43CB16FB43CD76C1410C86154270FA2742708B614270AF4F42711BF742"
                    b"72170A42778EED420783F6423A5E59423A417B423BE5BD42523C5542671CFC42767BFA0000000042"
                    b"715E5C423B0A042301040833230104084315431722104406682243C13F3C43C1FA92413FF2994273"
                    b"216542724047427230374272651542730C53427847B3420FB8FE426168E0426119E942612E274266"
                    b"05B2426E4D514277D5E9000000004273AAC7426179B02212270835221227084615438F0C73438EEE"
                    b"48BE71548CBC4D23EC41A145EC42743BE4427357B04271E87242717098426FEEB2426F273C41A129"
                    b"C3426FDC6D426D5EB642697B8E426A32CA4265D17C4270357E00000000427432C0426FBDBD221220"
                    b"075622122008061542CB18614403E0BD43D4FB6343D780D8410A573A427B9A1D427B15BC427ADB69"
                    b"427AA371427A38DE427D029A420CAC62423AD57B423AB1D7423BC3FB42508712426AA87F427B5921"
                    b"00000000427C039F423BB0162212021213221202122015432103C64405028043B9831E43BB1ADC41"
                    b"4A132F4281A8E3428170AA428170E1428186764281C2064283D700420E066C4252EAD04252C89D42"
                    b"53B5D74264541B427967954283A1FF000000004281C8644253B536221122091122112209191542CD"
                    b"DD8643E7EED443B4777243B5D856410BEB7142833B06428300754282E0624282B5EF42825F674282"
                    b"B67941F675994252616D42525BCC42574581426EF0E0427B77384282C3C900000000428368AE4253"
                    b"19E0221108075022110807581542CBC10A43FE27C743CB378443CB0D6E410AB78042865079428662"
                    b"81428677D64286A5FA4287416C4289D2774207240642794DBB4279050F42798E844280E376428540"
                    b"1B4289D341000000004286421A427969512210250657221025070615436E143E4403EE6F4390D2BF"
                    b"43902BCC418AB5A74287517442872D1E428729454287475E4287D28C428A96F9420CBCA042861236"
                    b"4285E7BE4285D85342864445428761B9428A963800000000428758844285FC1F2210131306221013"
                    b"13141542CD2E7643FDEF6C43CAA3CE43C9B4C4410B87CB428961394289518A42894F6A4289450342"
                    b"8969E2428B70B942070467428614C24285EC3C4285F1DC42872D644288B2F9428B67AC0000000042"
                    b"896DF3428606F022092708392209270848154363FB7D440C034043A608C143A4B5D04185E7E1428D"
                    b"ACB8428E15C8428E440B428E5590428E8918429076DE4216F02B428E6547428E3DC6428E2ED8428E"
                    b"1B2F428E73FD4290777C00000000428D932B428E4AA022091411162209141124154382DE214410A9"
                    b"78439E74CF439CCA6B4195DF20428FEA1C429115D04291BFF442922DA84292F70D42959A5A421DA2"
                    b"4142935652429328ED429317F64293003E429332CF4295A2E300000000428FCBA84293361E220902"
                    b"11202209021128154390E5F8441062B3438FDF6F438DC9B541A2FFD7429163D94292F4764294378E"
                    b"429502EF4296232F42991390421D35C64299785142996011429956E84298FA8D42977F9642990783"
                    b"00000000429168494299607A220826071022082607181542CD5E7543FE1B6943CAC3CC43C84F1941"
                    b"0BA31F4290E9CC42922E1642933C7742943A24429615F8429A240042071D15429891D8429870E042"
                    b"984C0142970E584296D663429A255F00000000428FF9C742987524220816082822081608331542D0"
                    b"6C5643FECC1D43CAB10743C85BC3410D5F604291A9CA42934AAE429492CE4295AD3742975B63429A"
                    b"DCC642078071429740D242971C9A429709654296B1AD42975C93429AD48A000000004290756B4297"
                    b"29CF220801115422080111591543349AAF4403EC7943AD8B9B43AB8A73415DC397428F1D704291CC"
                    b"4542938BF0429522A74297EE05429D21DE420CBA4C429553C942952A644295159042956BF2429786"
                    b"FD429D09C200000000428DFC3E42953B1C2207220745220722075115434EBFBD43FA3C4A4392DC6C"
                    b"4390E2BF4177664F428B7427428E4BC8428FFBE042919A484294C63D429ACE054204F5E342964AD9"
                    b"429639D6429614274294C56242955867429ACD7D00000000428A8CFE429637992207120855220712"
                    b"090415432A8C6343FE5C7E43A9164D43A71CC24153B7654289F500428C2C60428DB97F428F2ECB42"
                    b"91D8264296F541420741A44293F4EB4293DB214293BA86429276A7429293CB4296F3160000000042"
                    b"88F0BA4293DC80220702073522070207381543876088440059C14372A5F2436FCE32419A19CA4285"
                    b"BFF442889D7A428A3897428B908F428E2492429365B042089454428F0800428EFB79428EE590428D"
                    b"F6D0428EB289429368D10000000042858E07428EF811220622091922062209241543671F04440305"
                    b"0A43927A91439109A6418766F3428463A04286B8484287FF0C428928DF428B50F7428FE323420BA9"
                    b"59428D0942428CF92B428CDEDD428BE07A428BDD69428FE1DD000000004283DF3D428CF2CC220611"
                    b"1133220611114115430AAA7C4406421443C72EEA43C55B8D4132F2F042820F984283785642849CFD"
                    b"4285DB4542885C67428DBDF9420F8A55428DFD03428DE0F0428DB620428BED48428A2061428D9994"
                    b"0000000042813CA0428DCF83220531091322053109211542E7D1E5440259EB43CABF5C43C86AAC41"
                    b"1A72C2427CCBF6427EE27D42806308428172144283A4EE42888AD3420AE178429301E042930FC542"
                    b"92B2BC428DD417428894494288B8FF00000000427B64DE4292CF8F22051710122205171022154344"
                    b"6D2B43F6CA0F4394937A4393EEE5416D5A8642767ED0427931F8427B4585427D98844281023C4286"
                    b"00B3420313564280A2B542807E83428065B042802CB54281383C4285F0DE0000000042758E404280"
                    b"8C68220507071322050707251542CD253043FA0FBA43C6C66E43C79935410B828442744E4C4275A9"
                    b"B0427714DD4278C834427C4FBD428277F14204DD56425DBF72425D7617425E3F49426A0612427578"
                    b"794281F65B0000000042735719425DDECE22042611562204261210154309E9D243DA68A7439573BE"
                    b"4395C90E413227D4427177EF4272596A4273591642749C4342771E7A427EAE3E41E8C80D426768B9"
                    b"426723AF426932D8426ED63142745A64427E78DF000000004270FB33426797522204120844220412"
                    b"085115436F0D5344040052439079FB4390F4A2418B2BCC426C1CF7426D432D426E702D426FD32B42"
                    b"72ECA8427B7075420CD1DA4263BEC2426378B0426391D042686CFA42702E28427B4AE30000000042"
                    b"6BEB9C4263C86922033109122203310918154301E4084405555343C9B8A243CAFF194129A172426A"
                    b"B87A426AF74D426B791B426C46D4426E1D414274AB36420E6A4D4252F6B34252BBF842534329425C"
                    b"A30A4268CD514274550700000000426A99F042535BB1220314105322031411021542DD2D1444012A"
                    b"AF43CB0A1943CCFB1C41148BB44267AAC44267D6C84268529042690846426A5588427091BF420983"
                    b"144242CE9B424290F542438FF3425245CD42627A754270933C00000000426796D842434160220301"
                    b"085122030109011543813F2543F627944369D0DE436CE628419459274264BA3C4264109D42639C37"
                    b"4263E6A242646FB44268CFD44202BB3C4246225F4245E6E04247193B425312B9425DB326426882C3"
                    b"000000004264CA06424653AD2202170948220217100415431BEDA143FC112943AE1A5943AF681D41"
                    b"44E14B4266521D4265600B426547A94265B23742667B78426B51934205F962424F8D29424F3B4A42"
                    b"4FC9F94257BDB6426080B2426A9D48000000004266DDA2424F9E5C02402303241232230324124315"
                    b"43CB318A44F8C08144C5F41F44C5F7BF41883083426B0202426B5A5C426A37FD426C09F9426F4A72"
                    b"427B19F9425F64EC426F26B1426F06DA426D9A05426E793F42704301427A544F00000000426B163C"
                    b"426E7D9C2303101549230310160015441321A044FD620D44B3D13D44B46BE041AE76384267A47F42"
                    b"671FB542657DED4266CEC94268DCD74271417A4263F9924258D7604258BD3D42575A314258D22042"
                    b"630FFA427063480000000042679A0942585F082302270744230227075415443F947145008C5E44A1"
                    b"4E8344A20C7941D1250A4268C7294267F68A4264B4334264956E42630798426032B64267CBEE4254"
                    b"74BF425418EC42528458425369D6425ADA89425F672C0000000042688E0B4253921A230215101623"
                    b"0215102815440D37D444FA98E144B3FCF744B4A66A41A9AF25426EBE2C426E2847426BFF88426C73"
                    b"97426BF70C426CBDD7426132704258F2E14258ADA7425717BA4258750A42641410426CA50E000000"
                    b"00426EB83C425829192302030951230203100015442CDB5044F4919E449E23F6449EF79E41C2C3B1"
                    b"4273C5E842743B2D4273205E4274ADA24276A66E427E5093425B678942530CAA4253AAC342526AB2"
                    b"42558BF7426940B6427CBCB30000000042740DB042536219230120130023012013081544750D0B44"
                    b"FCAED6448228514482AE0B41F909BE4273F1A54274079E4272E82E42746FA242764636427E0D9242"
                    b"634527425FDE4C425FD5BA425E8BE242603047426E3116427D609C000000004273F084425F88DA23"
                    b"01111316230111132615441A670C44F9ED9144ACBA0B44AD463241B446714277AD07427753C34275"
                    b"965D427672884276D870427ABB2042608A3B425FBB7C425F68FF425DC632425F5A2C426DF33A4279"
                    b"D44C000000004277AFB8425EE74D221228153022122815411543D1589044FA44C344C5EE9F44C5C9"
                    b"E1418AE71E42796D794277B4C242758B024275F5554275BD2D4276764A4260DFB94277C332427799"
                    b"324276288F4276E40A427529F54276176D000000004279499B42770A102212270759221227083015"
                    b"442DBA18442C0629C0D9F776C0D7493841C37079427A049642790DEA427605D942763B60427548D3"
                    b"4274A42D41C21E3742797E7E4276D030426FFDE5427042DD427177E34273DAC5000000004279D055"
                    b"4278D4272212150711221215072115444E21E944FAC3D74493B2E3449438B741DC255442809E9442"
                    b"809FDA427F97FF42804AD44280864B428298D642615CC6426535314264E638426361D842656D5F42"
                    b"750D9842822427000000004280A6D6426494D22212050937221205094415448F64C844FDCB5B445C"
                    b"CD25445DAA76420BC8FD4281EA594281E83342813E644281D5E742825E9E4285414142646425426C"
                    b"FC5E426C5A5C426A9EFE426C3496427A51104284FB78000000004281CD2E426BEF94221125085122"
                    b"1125090015446B389044FB65B14485C9694485966241F1CBDB4282A8A442828491428184664281E1"
                    b"CE428210EF42845E1C4261FCD54280C3B54280B5AD428003704280805D428173E44284497B000000"
                    b"0042828DCC428076252211140857221114090615443FEF4C44FE44CB449E4D25449EB11E41D16A26"
                    b"4285D4BC428667BF428612E64286CE7B42875D62428A411A4264DF95426E3DCC426D8332426BC9D9"
                    b"426CE6064280DD664289D3DD000000004286211B426D037D22110210492211021058154450E64E44"
                    b"F66397448DF070448D9A1A41DE391B4287236F42874E8F4286CE35428767954287E558428AC36642"
                    b"5D1FF44284E5074284CD19428413C842849DCF42866FB8428AB7310000000042873E7A42848BB222"
                    b"102116462210211654154462C34944F95DC24487FC1D44876A1741EB8A0242888ECA428894034287"
                    b"9C124287EB654287B99B4288BB2D425FFDC3428A0C7F4289F72C428940C04289A3934288650F4288"
                    b"B59700000000428890C94289B2B322101213072210121315154440FDDD44F536F24494B8034493EE"
                    b"8441D237D3428A681B428A92B24289C8B1428A29EA428A11BB428B3D51425C031E428DEB61428DD9"
                    b"FF428D2375428D5DCB428B77CB428B5E2200000000428A879B428D8EB72209301258220930130715"
                    b"44771A2144F8D5BF447A915C447949E841FA8BAB428E25F2428EED79428E3F40428E9843428E1F4A"
                    b"428DCAAD425F7985428EFDF9428EE568428E2FF8428E9B10428DED31428DC1F400000000428E95E7"
                    b"428EA3272209221430220922143815445B4CD944F62034448879C8448786C941E5FE91428EA58D42"
                    b"90FBDC4290F2F14291C6834292368B4294D20E425CDFE54293FEB642940306429364D14293E67242"
                    b"9323044294C5AD00000000428FEF7A4293CDBB22091214342209121447154420118F44F7A79A44A7"
                    b"9ED344A5E41E41B8C315428FF2DB42925CFF42923C95429326AE4293A5C442964EA0425E55CB429F"
                    b"4B9F429F68ED429EBCA7429EC1F342996FE04296A437000000004290DE2F429F1238220901074322"
                    b"090107511544592DF544FB6C43448ED549448D5F0541E46A08428FE05942948C774295C636429740"
                    b"5642989457429D2E2742620359429D76F0429D84B8429CDB06429D3DDD429B63FA429D1F88000000"
                    b"0042926973429D403622082408052208240817154456079444F3DCDA4488D9114487564441E21023"
                    b"428DE130429367C24294FB2F429682C24297C926429C316A425ABE3F429E72DD429EB7C6429E206D"
                    b"429E5817429BA809429C5ABE000000004290D3B5429E6E922208121154220812120415442BB17D44"
                    b"FDA74A44A7CE8B44A5BBFF41C1DC70428F830C429516F6429619EE4297DBEC4299D13142A0255F42"
                    b"643F9942A5217A42A55C4642A4B3BB42A502E242A07D9F429FFB52000000004291C60A42A5092522"
                    b"080113112208011320154449878D44FE51C144998DFB4497C05C41D8AE3E428E84734293D2CC4295"
                    b"48F44297357A4298E54C429E2F7D4264ECCA42A17C4342A1B68942A1282742A19F0E429E11B7429E"
                    b"2069000000004291286442A17AFA2207221223220722123215445B8F5744FC69F5448EA249448CD9"
                    b"2D41E63013428B65424290371242917E6842937E9F4295EF2B429E0B1B4263001F42A0C50E42A12B"
                    b"F642A0C39C42A159A0429CCA91429E046900000000428E0AFC42A106DE2207150706220715071115"
                    b"44AC0C40450066304429803F4427D2BB4220CD2142883460428DA1894290D75F429494414296D9F8"
                    b"429D29F342677BF0429501AE4294F8D242943438429482874296DE75429D207800000000428D160E"
                    b"4294A563220708132122070813291544877E5444F862B74461C8C8445F696E4206049E42891EA142"
                    b"8DD2B0428F35C3429159634293293E4298F5F3425F0A214298590D429883764297ECB44298625442"
                    b"9699C9429913F700000000428C4799429849C3220701133222070113391544796F1744F8DEBB4478"
                    b"4E5F447592E141FC42164285D125428A168E428B8585428D84AD428F8ADF42963DCA425F823D4298"
                    b"9D464298F83042986541429896CB4294E3CF42966F020000000042887E194298A9BF220624104822"
                    b"0624105615448C819644FB53E3445DA49A445BE9A14209AD8A428445FD428891864289EFAF428BA3"
                    b"B8428CFD8F4291BBD64261EB2E428FE1F44290101B428F714442900035428F0EFD4291A6EC000000"
                    b"00428743A0428FD5512206171017220617102515448A6C3844FD515A4465CA45446393D442082838"
                    b"428116BE42858FC342888348428AA135428CA7804292D29E4263E8B642921F9242926C684291DAD6"
                    b"4292429142902C6E4292AB9400000000428459C9429228DF2206100652220610065915448B802B44"
                    b"FADFA7445EBEF7445D50B34208F1A8427E1AD44282E0AC42859FA64287D8EF4289F87342905CD842"
                    b"617837428A133A428A4A8C4289D27F428A8D44428B3B7C42905984000000004281E422428A2C6822"
                    b"060307112206030721154430693344F629AA449DF511449D23C641C58444427A13EF428169BB4282"
                    b"41934283DB274285CD00428BEB6C425CE8E142896CC34289786C4288CF4E428943AF42885062428B"
                    b"E3CA00000000427DC3FC42893A1522052308412205230850154435A1F544ED6E3D44929D43449204"
                    b"DF41C98A4A4276ED00427D9F43427ED1B84280DAFF42829F7142888B684254DC5F4285791642855E"
                    b"9C4284946E4284BAD5428434E242887338000000004279E0494285081B2205130726220513073315"
                    b"4493694F44F5B91E44449F9F44442800420EB7A54273BC7842779D8D427A63AC427DCE734280891D"
                    b"4285E493425C7E24427D42A1427D11E4427B9112427CA0F84280465F4285D747000000004276CA3A"
                    b"427C867A22050511312205051140154469226044F0CAF3447873854477990941F0414C42724A4F42"
                    b"765F16427813FA427AD0A6427DFA1E4284521A4257E7BB42815D21428153A1428093B94280D78842"
                    b"80893742846F23000000004274AF2A4281029822042511462204251158154398A96144FC79CE44D6"
                    b"4F7544D5FCC94161CCAF42736F6D4274D5BC4273F4944275CB744278099B428045C342630FFD427C"
                    b"99F1427C7622427AFD3E427BBD0E427AA9694280286E0000000042735F5E427BE13F220412143122"
                    b"041214431543C863D644F9BF4B44C7A65544C65AC84186F209426F9A224270B372426FC76D4271E8"
                    b"CB42752CD34280090D42605CF5428F29BC428F8870428ECB63428E6D99428531A442809E04000000"
                    b"00426FBF7F428F05B322032907362203290749154421035044FF4B8644AEC9DE44AF47CC41B981A3"
                    b"426D7A31426FC9DA426F45EB427157B74273FB21427CCED44265ECA3425F04FD425EC793425D45D8"
                    b"425E95DC426BA394427B22C100000000426E677D425E5E972203171302220317131115444CD39344"
                    b"FD1FEF4496B6254496829641DB29F74269CC7A426A77B14269E2AF426BF1BF426F17D64279799342"
                    b"63B6DF427542B4427549644273E3974274A62A4273024E4279200700000000426A2C774274B71A22"
                    b"03081056220308110415445E282744F935AA448A2197448A79CE41E81EA74267FF94426829A84267"
                    b"96074269CF23426DDCC0427AF30A425FD6B94260D1504260AC4D425F41F9426078C5426A096E427A"
                    b"2559000000004268188142602F9922022515522202251602154439EB1D44FF7E0F44A2888144A327"
                    b"8541CCD36C42683C704267FBF342663A3A42676AA34268FB17426F9477426620B6425823BC4257F9"
                    b"724256828D4257C967426280D4426EF3B20000000042683AD642578FCB&&4DBC\x03"
                ),
                True
            )
        ]

        with TlsSocket(self.ip, self.port) as tls:
            for case in cases:
                actual = tls._data_integrity_check(case[0])
                expected = case[1]

                self.assertEqual(actual, expected)

if __name__ == "__main__":
    unittest.main()